#!/usr/bin/env ruby

require 'reposit'
require 'optparse'

setup = false
organization = nil
options = {}

options_parser = OptionParser.new do |opts|
  opts.banner = "Usage: reposit <repository_name> [options]"

  opts.on("-s", "--setup", "Reset your GitHub credentials") do |s|
    setup = true
  end

  opts.on("-o", "--organzation NAME", "Create (private) repository on an organization") do |org|
    options[:organization] = org
  end
end

begin
  options_parser.parse!
  mandatory = [:organization]
  missing = mandatory.select{ |param| options[param].nil? }
  if not missing.empty?
    puts "Missing options: #{missing.join(', ')}"
    puts options_parser
    exit
  end
rescue OptionParser::InvalidOption, OptionParser::MissingArgument
  puts $!.to_s
  puts options_parser
  exit
end  

if setup
  path = File.expand_path('~') + '/.reposit'
  `rm #{path} > /dev/null 2>&1`
  Reposit::CredentialsSetter.run
else
  if !ARGV[0]
    puts `reposit --help`
  elsif !Reposit::SetupChecker.check
    Reposit::CredentialsSetter.run
    Reposit::RepositoryMaker.run(ARGV[0], options[:organization])
  else
    puts "Organization: #{organization}"
    Reposit::RepositoryMaker.run(ARGV[0], options[:organization])
  end
end